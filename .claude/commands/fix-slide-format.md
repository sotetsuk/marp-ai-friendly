特定ページのフォーマット問題（テキストはみ出し、図表配置、余白など）を自動検出・修正するスキル。

## Instructions

対象ファイルとページ番号: $ARGUMENTS

引数は `<file.md> <page_number>` の形式で指定してください（例: `example.md 3`）。

### Step 0: 引数バリデーション

1. `$ARGUMENTS` が空の場合、以下のエラーを表示して終了:
   > Error: 引数が指定されていません。使用法: `/fix-slide-format <file.md> <page_number>`
2. `$ARGUMENTS` をスペースで分割し、最初の要素をファイルパス、2番目の要素をページ番号とする。どちらかが欠けている場合、エラーを表示して終了:
   > Error: ファイルパスとページ番号の両方を指定してください。使用法: `/fix-slide-format <file.md> <page_number>`
3. Read ツールでファイルを読み込む。ファイルが存在しない場合はエラーを表示して終了。
4. ファイルに `marp: true` が YAML front matter に含まれていることを確認。含まれていない場合:
   > Error: このファイルは Marp スライドではありません（`marp: true` が見つかりません）。
5. ページ番号が正の整数であることを確認。そうでない場合:
   > Error: ページ番号は正の整数で指定してください。

### Step 1: スライド構造解析

1. ファイル内容を `---` で区切ってページを特定する。
2. **重要**: 先頭の `---` で囲まれた YAML front matter はスライド区切りではなく、front matter として扱う。front matter の後の最初のコンテンツがページ1となる。
3. front matter の後、次の `---`（行頭に単独で現れるもの）までがページ1、その次の `---` までがページ2、...というように数える。
4. 指定されたページ番号が総ページ数を超えている場合:
   > Error: ページ $page_number は存在しません。このスライドは全 $total_pages ページです。
5. 対象ページの開始行と終了行を記録する。

### Step 2: PNG エクスポート

Bash ツールで以下のコマンドを実行:

```
mkdir -p dist && npx @marp-team/marp-cli <file_path> --theme-set themes/ai_friendly.css --images png --image-scale 2 --output dist/ --allow-local-files
```

コマンドが失敗した場合、エラーを表示して終了。

### Step 3: 対象ページの画像読み込み

エクスポートされた PNG ファイルは `dist/<basename>.<NNN>.png` 形式（3桁ゼロ埋め、1始まり）。

1. 対象ページ番号に対応する PNG ファイルパスを特定する。例えばページ3なら `dist/<basename>.003.png`。
2. `sips` で分析用にリサイズした一時ファイルを作成する（高解像度の原本は維持）:
   ```
   sips -z 360 640 dist/<basename>.<NNN>.png --out /tmp/<basename>.<NNN>.small.png
   ```
   - `sips -z` は `<height> <width>` の順。640x360 は 16:9 アスペクト比を維持。
   - 640x360 で約 60KB となり、Read ツールのトークン制限内に収まる。
3. Read ツールで `/tmp/<basename>.<NNN>.small.png` を読み込む。
4. 読み込み後、一時ファイルを削除する:
   ```
   rm /tmp/<basename>.<NNN>.small.png
   ```

### Step 4: フォーマット問題の検出

読み込んだ画像をマルチモーダルで分析し、以下のフォーマット問題**のみ**を検出する（内容の正確性やスライドの構成は評価しない）:

- **テキストはみ出し**: テキストがスライド境界からはみ出している、または端に極端に近い
- **画像配置・サイズ**: 画像が大きすぎる/小さすぎる、配置がおかしい
- **テーブル崩れ**: テーブルがスライドに収まっていない、カラムが崩れている
- **余白の問題**: コンテンツが多すぎてスライドが窮屈、または余白が極端に不均等
- **数式はみ出し**: 数式がスライドの幅を超えている

**問題が見つからない場合**:
> ページ $page_number にフォーマット上の問題は見つかりませんでした。修正は不要です。

と表示して終了する。

### Step 5: フォーマット修正

Step 1 で特定した対象ページの行範囲に対して、Edit ツールで Markdown を修正する。

**修正方針**:
- 意味やコンテンツを変えず、最小限のフォーマット修正のみ行う
- 対象ページの範囲内のみを修正する（他のページに影響を与えない）

**利用可能な修正手法**:

1. **テキストはみ出し対策**:
   - テキストの短縮（冗長な表現を簡潔にする）
   - `<!-- fit -->` ヘッダーの利用
   - フォントサイズ調整: `<span style="font-size: 0.9em">...</span>` やページ先頭に `<style scoped>section { font-size: 28px; }</style>` を追加

2. **画像サイズ調整**:
   - Marp の画像サイズ構文: `![h:200px](image.png)` または `![w:400px](image.png)`

3. **画像配置調整**:
   - `figure-wrapper` の CSS クラス: `center`（中央配置）、`right`（右寄せ）、`center withtext`（テキストと共存する中央配置）

4. **テーブル修正**:
   - セル内容の短縮
   - テーブル全体のフォントサイズ調整

5. **数式修正**:
   - LaTeX サイズコマンド: `\small`、`\footnotesize`
   - `aligned` 環境で複数行に分割

### Step 6: 検証（イテレーション）

修正後、再度 PNG エクスポートと画像確認を行う（Step 2〜4 を繰り返す）。

- 問題が解消されていれば、修正内容のサマリーを日本語で表示して終了。
- まだ問題がある場合、追加の修正を行う（Step 5 に戻る）。
- **イテレーション上限**: 合計最大3回のエクスポート（初回 + 検証2回）。上限に達した場合、残っている問題があればその旨を報告して終了。

### 出力フォーマット

最終的な出力は日本語で、以下の構造とする:

1. **検出された問題**: 最初に検出されたフォーマット問題のリスト
2. **実施した修正**: 各修正内容の説明
3. **検証結果**: 修正後の状態（問題が解消されたか、残存する問題があるか）
